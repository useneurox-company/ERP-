# Исправление резервирования в альтернативах

## Статус: ЗАВЕРШЕНО

## Дата: 28.11.2025

## Проблема:
При выборе одной и той же альтернативы для нескольких позиций, обе показывали полное количество на складе (12 шт), хотя первая позиция уже зарезервировала весь остаток.

## Причина:
В `service.ts` функция `getComparisonWithItems()`:
- `warehouse_quantity` рассчитывался правильно с учётом резервирования
- НО `ai_suggestions_parsed[].quantity` показывал ОРИГИНАЛЬНЫЕ значения из БД

## Решение:

### 1. Backend: service.ts
- Добавлено поле `available_quantity` в интерфейс `ai_suggestions_parsed`
- Реализован двухпроходный алгоритм:
  1. Первый проход: собираем все резервирования от выбранных позиций
  2. Второй проход: обогащаем альтернативы доступными количествами
- Для каждой альтернативы рассчитывается `available_quantity = общее - зарезервировано`

### 2. Frontend: ExcelComparisonView.tsx
- Изменено отображение в dropdown альтернатив:
  - "На складе: X" → "Доступно: X"
  - Используется `alt.available_quantity ?? alt.quantity`
- Для предложения AI используется `item.warehouse_quantity` (уже с учётом резервирования)

## Изменённые файлы:
- `server/modules/procurement/service.ts`:
  - Строки 27-34: интерфейс с `available_quantity`
  - Строки 180-280: двухпроходный алгоритм резервирования
- `client/src/components/procurement/ExcelComparisonView.tsx`:
  - Строка 601: "Доступно: {item.warehouse_quantity}"
  - Строка 628: "Доступно: {alt.available_quantity ?? alt.quantity}"

## Как работает теперь:
```
Склад: 12 шт товара X

До:
- Позиция 1 выбирает товар X → видит "На складе: 12"
- Позиция 2 выбирает товар X → видит "На складе: 12" (неправильно!)

После:
- Позиция 1 выбирает товар X → видит "Доступно: 12"
- Позиция 2 выбирает товар X → видит "Доступно: 0" (правильно!)
```

## Предыдущие изменения:
- Унификация отображения неточных совпадений (Вариант A)
- Резервирование остатков при выборе альтернатив
- Inline редактирование количества в колонке "Нужно"
- Сортировка по уверенности (high → alternative_selected → medium → low → missing)
